<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/d3-queue.v1.min.js"></script>
<style>
    .region {
        fill: #000;
        stroke: #fff;
        stroke-width: 1px;
    }
    .region:hover {
        fill: #666;
    }
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5  1px 0;
        border-radius: 2px;
        opacity:1;
        position: absolute;
    }
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
  
  </style>
</head>

<body>
  <div>
  </div>
  <script>
    function createContentDetail(){
    var width = 900, height = 780;
    var displayValue = d3.format(",.0f");

    var svg = d3.select( "body" )
        .append( "svg" )
        .attr( "width", width )
        .attr( "height", height );

    //Affichage de la carte
    var projection = d3.geo.conicConformal()
   			.translate([width/2, height/2])
    			.center([2.454071, 46.279229]).scale(5000);    

    var path = d3.geo.path()
                 .projection(projection);
   
    var color = d3.scale.quantile()
    			.range(['rgb(215,48,39)','rgb(215,48,39)',
                          'rgb(252,141,89)',
                          'rgb(254,224,139)',
                          'rgb(217,239,139)',
                          'rgb(45,207,96)',
                          'rgb(26,152,80)']);

    
    queue()  // permet de charger les fichiers de mani√®re asynchrone
  		.defer(d3.json, "files/regions.geojson")
  		.defer(d3.csv, "files/Classement.csv")
  		.await(processData);
       
   

    function processData(error,francejson,classementHopitaux) {

      
        var max = 0;
        var min = 10000000;

        for (var i = 0; i < classementHopitaux.length; i++) {              
            //Valeur associee a la region 
            var dataValue = d3.values(classementHopitaux[i]);    
            var value =	parseFloat(dataValue[3]);           
            if(min > value){
                min = value;
            }
            if(max < value){
                max = value;
            }
        }
                    

        color.domain([min, max]);

        var tooltip = d3.select('body').append('div')
            .attr('class', 'hidden tooltip');
   
      svg.selectAll("path")
      	 .data(francejson.features)
      	 .enter()
         .append("path")
         .attr("d", path)
      	 .style("opacity",1)
         .style("fill", function(d) {
                var value = d.properties.value;        
                if (value) {
                    return color(value);
                } else {
                    return "#ccc";
                }             
        });
  
  
  
        // draw legend
        var legend = svg.selectAll(".legend")
            .data(color.quantiles())
                  .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i){ 
                return "translate(0," + i * 20 + ")"; 
            });

        // draw legend colored rectangles
        legend.append("rect")
            .attr("x", width - 18)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", color);

                  var valueTmp;
                  var PerviousValueTmp = -1;
                  var ret;

        // draw legend text
        legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "end")
            .text(function(d) { valueTmp =  Math.round(d);  
                                  ret = PerviousValueTmp + 1 + "-" + valueTmp;
                                  PerviousValueTmp = valueTmp;
                                  return ret;})

  
        // add circles to svg
        /*svg.selectAll("circle")
		.data(classementHopitaux).enter()
		.append("circle")
		.attr("cx", function (d) { console.log(d.lat); return  projection(d).lat; })
		.attr("cy", function (d) { return  projection(d).long; })
		.attr("r", "8px")
		.attr("fill", "red");*/
        
        
        svg.selectAll(".pin")
            .data(classementHopitaux)
            .enter().append("circle", ".pin")
            .attr("r", 2)
            .attr("transform", function(d) {
              return "translate(" + projection([
                d.lat,
                d.long
              ]) + ")";
            })
            .style("fill", function(d) {
                var value = d.ScoreAgrege;
        
        	if (value) {
                    return color(value);
                } else {
                    return "#fff";
                }
              
              })
              .on('mousemove', function(d) {
                            var mouse = d3.mouse(svg.node()).map(function(d) {
                                return parseInt(d);
                            });
                            tooltip.classed('hidden', false)
                                .attr('style', 'left:' + (mouse[0] + 15) +
                                        'px; top:' + (mouse[1] - 35) + 'px')
                                    .style('opacity',1)
                                .html(d.RaisonSociale + "<br/> Score: " + d.ScoreAgrege)
                                        d3.select(this).style('opacity',0.3);
                      
                        })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
                    d3.select(this).style('opacity',1)
              });
        
   
};
    }
  </script>
</body>
